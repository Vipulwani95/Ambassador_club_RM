function doGet(e) {
  const SHEET_ID = "12pkHI57LwU7EDMufFro0gcGONXEdN5HJkt_lD_78cU8";
  const TAB_NAME = "Jan-2026"; // CHANGE if needed

  const ss = SpreadsheetApp.openById(SHEET_ID);
  const sheet = ss.getSheetByName(TAB_NAME);

  if (!sheet) {
    return ContentService
      .createTextOutput(JSON.stringify({error: "Sheet not found: " + TAB_NAME}))
      .setMimeType(ContentService.MimeType.JSON);
  }

  const data = sheet.getDataRange().getValues();
  
  // Get query parameters
  const params = e.parameter;
  const action = params.action;
  const submitter = params.submitter;

  // If requesting all submitters
  if (action === 'getAllSubmitters') {
    const submitters = new Set();
    for (let i = 1; i < data.length; i++) {
      const phone = normalizePhone(data[i][1]); // Submitter Phone is column index 1
      if (phone) {
        submitters.add(phone);
      }
    }
    return ContentService
      .createTextOutput(JSON.stringify({submitters: Array.from(submitters)}))
      .setMimeType(ContentService.MimeType.JSON);
  }

  // If searching for specific submitter
  if (submitter) {
    const normalizedSearch = normalizePhone(submitter);
    const filtered = [data[0]]; // Keep headers
    
    for (let i = 1; i < data.length; i++) {
      const rowPhone = normalizePhone(data[i][1]);
      if (rowPhone === normalizedSearch) {
        filtered.push(data[i]);
      }
    }

    if (filtered.length === 1) {
      return ContentService
        .createTextOutput(JSON.stringify({error: "No data found for this phone number"}))
        .setMimeType(ContentService.MimeType.JSON);
    }

    return ContentService
      .createTextOutput(JSON.stringify({data: filtered}))
      .setMimeType(ContentService.MimeType.JSON);
  }

  // Return all data if no parameters
  return ContentService
    .createTextOutput(JSON.stringify({data: data}))
    .setMimeType(ContentService.MimeType.JSON);
}

function normalizePhone(phone) {
  if (!phone) return '';
  const phoneStr = String(phone).replace(/\D/g, '');
  return phoneStr.slice(-10);
}
